<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CASH REGISTER - POS Log Analyzer v2.0</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--chip:#1f2937;--border:#334155;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(160deg,#0b1220 0%,#111827 100%);color:var(--text)}
    header{position:sticky;top:0;padding:16px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);background:linear-gradient(160deg,#0b1220ee,#111827ee)}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    main{display:grid;grid-template-columns:350px 1fr;gap:24px;align-items:start;padding:16px;max-width:1400px;margin:0 auto}
    @media (max-width:1200px){main{grid-template-columns:1fr;gap:16px}}
    @media (min-width:1600px){main{grid-template-columns:400px 1fr;gap:32px}}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 30px #00000055}
    .card h2{font-size:16px;margin:0 0 8px 0;color:#dbeafe}
    .card .body{padding:14px}
    .drop{border:1px dashed #475569;border-radius:14px;padding:14px;text-align:center;color:var(--muted);cursor:pointer}
    .drop:hover{border-color:#64748b;color:#cbd5e1}
    .controls label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
    .controls input[type="text"], .controls select, .controls input[type="date"]{width:100%;padding:10px 12px;background:#0b1324;color:var(--text);border:1px solid var(--border);border-radius:8px;outline:none}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;display:inline-flex;gap:8px;align-items:center}
    .chip input{accent-color:var(--accent)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1324;color:#cbd5e1;cursor:pointer;text-decoration:none}
    .btn.primary{background:#0b3a73;border-color:#1e40af;color:#ffffff}
    .btn.small{padding:6px 8px;font-size:11px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .meta{display:flex;flex-wrap:wrap;gap:8px;color:#a3a3a3;font-size:12px}
    .meta .tag{background:#0b1324;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #1f2937;font-size:13px}
    th{color:#cbd5e1;text-align:left;position:sticky;top:0;background:#0f172a;z-index:1}
    tbody tr:hover{background:#0d1528}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kpi .box{background:#0b1324;border:1px solid var(--border);padding:12px;border-radius:14px}
    .kpi .val{font-size:18px;font-weight:700}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px}
    .pill.ok{color:#10b981;border-color:#10b98122;background:#10b98111}
    .pill.bad{color:#ef4444;border-color:#ef444422;background:#ef444411}
    footer{padding:20px;color:#94a3b8;text-align:center}
    .hide{display:none}
    .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:12px}
    .tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;color:var(--muted)}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .comparison-card{background:#0b1324;border:1px solid var(--border);padding:16px;border-radius:12px}
    .comparison-card h3{margin:0 0 12px 0;font-size:14px;color:#cbd5e1}
    .metric-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .day-item {padding: 6px 10px;margin: 2px 0;background: #0b1220;border: 1px solid var(--border);border-radius: 6px;cursor: pointer;font-size: 12px;display: flex;justify-content: space-between;align-items: center;}
    .day-item:hover {background: #0d1528;border-color: #475569;}
    .day-item.selected {background: #0b3a73;border-color: var(--accent);color: #ffffff;}
    .day-item .day-stats {font-size: 10px;color: var(--muted);}
    .day-item.selected .day-stats {color: #cbd5e1;}
    .timeline-item {display: flex;align-items: center;padding: 8px;margin: 4px 0;background: #0b1220;border: 1px solid var(--border);border-radius: 8px;font-size: 12px;}
    .timeline-time {width: 60px;font-weight: 600;color: var(--accent);flex-shrink: 0;}
    .timeline-content {flex: 1;margin-left: 12px;}
    .timeline-operator {color: var(--muted);font-size: 11px;}
    .hourly-bar {background: var(--accent);height: 4px;border-radius: 2px;margin-top: 2px;}
    .daily-grid {display: grid; grid-template-columns: 320px 1fr; gap: 20px; align-items: start;}
    @media (max-width: 1000px) {.daily-grid { grid-template-columns: 1fr !important; }}
  </style>
</head>
<body>
  <header>
    <h1>CASH REGISTER - POS Log Analyzer v2.0 • Importa, filtra e analizza</h1>
  </header>
  <main>
    <section class="card">
      <div class="body">
        <h2>1) Importa file log</h2>
        <div id="drop" class="drop">
          Trascina qui il file <b>.log</b> oppure <label for="file" class="btn" style="margin:8px auto 0;">Scegli file…</label>
          <input id="file" type="file" accept=".log,.txt" class="hide" />
        </div>
        <div class="meta" id="meta"></div>
        
        <hr style="border-color:#1f2937;margin:14px 0;">
        
        <h2>2) Selezione Periodo</h2>
        <div style="background: #0b1324; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-top: 8px;">
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 8px;">Filtra per Periodo</label>
          <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
            <input type="date" id="period1Start" style="flex: 1;">
            <span style="color:var(--muted);font-size:11px">→</span>
            <input type="date" id="period1End" style="flex: 1;">
          </div>
          <button id="btnApplyPeriod" class="btn primary" style="width: 100%; justify-content: center;">Applica Filtro</button>
        </div>
        <div style="margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap;">
          <button class="btn small" onclick="setQuickRange('today')">Oggi</button>
          <button class="btn small" onclick="setQuickRange('week')">Questa Settimana</button>
          <button class="btn small" onclick="setQuickRange('month')">Questo Mese</button>
        </div>
        
        <hr style="border-color:#1f2937;margin:14px 0;">
        
        <h2>3) Filtri</h2>
        <div class="controls">
          <label>Operatore</label>
          <select id="operatorSelect" multiple size="5"></select>
          <label style="margin-top:12px">Tipi di operazione</label>
          <div id="typeChips" class="chips"></div>
          <label>Cerca nelle note</label>
          <input id="searchInput" type="text" placeholder="es. tavolo, BANCO, articolo, conto…" />
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnReset" class="btn">Azzera filtri</button>
            <button id="btnExport" class="btn">Esporta CSV</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="body">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('overview')">Panoramica</div>
          <div class="tab" onclick="switchTab('daily')">Analisi Giornaliera</div>
          <div class="tab" onclick="switchTab('details')">Dettagli</div>
        </div>

        <div id="overviewTab">
          <h2>Statistiche Generali</h2>
          <div class="kpi" id="kpi">
            <div class="box"><div class="label">Eventi rilevati</div><div class="val" id="kpiEvents">0</div></div>
            <div class="box"><div class="label">Totale Scontrini (€)</div><div class="val" id="kpiScontrini">0.00</div></div>
            <div class="box"><div class="label">Totale Mov. Gestionali (€)</div><div class="val" id="kpiGestionali">0.00</div></div>
            <div class="box"><div class="label">Preconti (€)</div><div class="val" id="kpiPreconti">0.00</div></div>
          </div>
          <div style="margin-top:12px">
            <div class="meta" id="statsOperators"></div>
          </div>
        </div>

        <div id="dailyTab" class="hide">
          <h2>Analisi Giornaliera</h2>
          <div class="daily-grid">
            <div style="background: #0b1324; border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-width: 300px;">
              <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #cbd5e1;">Seleziona Giorno</h3>
              <input type="date" id="dailyDatePicker" style="width: 100%; padding: 10px 12px; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
              <div id="availableDays" style="max-height: 250px; overflow-y: auto;">
                <h4 style="margin: 12px 0 8px 0; font-size: 12px; color: var(--muted);">Giorni Disponibili:</h4>
                <div id="daysList"></div>
              </div>
            </div>
            <div style="min-width: 0;">
              <div id="dailyStats">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 16px;">
                  <div class="comparison-card">
                    <h3>Statistiche del Giorno</h3>
                    <div class="metric-row"><span>Data:</span><strong id="selectedDateDisplay">-</strong></div>
                    <div class="metric-row"><span>Eventi Totali:</span><strong id="dailyEventsCount">0</strong></div>
                    <div class="metric-row"><span>Scontrini:</span><strong id="dailyScontrini">€ 0,00</strong></div>
                    <div class="metric-row"><span>Mov. Gestionali:</span><strong id="dailyGestionali">€ 0,00</strong></div>
                    <div class="metric-row"><span>Preconti:</span><strong id="dailyPreconti">€ 0,00</strong></div>
                  </div>
                  <div class="comparison-card">
                    <h3>Distribuzione Oraria</h3>
                    <div id="hourlyDistribution" style="font-size: 11px; max-height: 150px; overflow-y: auto;">
                      <div style="color: var(--muted); text-align: center; padding: 20px;">Seleziona un giorno</div>
                    </div>
                  </div>
                </div>
                <div class="comparison-card" style="margin-bottom: 16px;">
                  <h3>Performance Operatori</h3>
                  <div id="dailyOperators"></div>
                </div>
                <div class="comparison-card">
                  <h3>Timeline del Giorno</h3>
                  <div id="dailyTimeline" style="max-height: 300px; overflow-y: auto;">
                    <div style="color: var(--muted); text-align: center; padding: 20px;">Seleziona un giorno per vedere la timeline</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="detailsTab" class="hide">
          <h2>Dettagli Transazioni</h2>
          <div style="overflow:auto;max-height:60vh">
            <table>
              <thead>
                <tr><th>Data/Ora</th><th>Operatore</th><th>Tipo</th><th>Importo</th><th>Dettagli</th></tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>
  <footer>Suggerimento: seleziona più operatori tenendo premuto Ctrl/⌘. Usa i preset rapidi per analisi temporali.</footer>

<script>
(function(){
  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');
  const tbody = document.getElementById('tbody');
  const meta = document.getElementById('meta');
  const typeChips = document.getElementById('typeChips');
  const operatorSelect = document.getElementById('operatorSelect');
  const searchInput = document.getElementById('searchInput');
  const btnReset = document.getElementById('btnReset');
  const btnExport = document.getElementById('btnExport');
  const kpiEvents = document.getElementById('kpiEvents');
  const kpiScontrini = document.getElementById('kpiScontrini');
  const kpiGestionali = document.getElementById('kpiGestionali');
  const kpiPreconti = document.getElementById('kpiPreconti');
  const statsOperators = document.getElementById('statsOperators');
  const period1Start = document.getElementById('period1Start');
  const period1End = document.getElementById('period1End');
  const dailyDatePicker = document.getElementById('dailyDatePicker');
  const daysList = document.getElementById('daysList');
  const selectedDateDisplay = document.getElementById('selectedDateDisplay');
  const dailyEventsCount = document.getElementById('dailyEventsCount');
  const dailyScontrini = document.getElementById('dailyScontrini');
  const dailyGestionali = document.getElementById('dailyGestionali');
  const dailyPreconti = document.getElementById('dailyPreconti');
  const dailyOperators = document.getElementById('dailyOperators');
  const dailyTimeline = document.getElementById('dailyTimeline');
  const hourlyDistribution = document.getElementById('hourlyDistribution');

  let allEvents = [];
  let allTypes = new Set();
  let allOperators = new Set();
  let currentTab = 'overview';
  let selectedDay = null;

  function formatDate(date) {
    return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
  }

  function formatDisplayDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const days = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
    const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
  }

  function sumBy(arr, key){ return arr.reduce((acc,o)=> acc + (o[key]||0), 0); }
  function groupBy(arr, fn){ return arr.reduce((acc,o)=>{ const k = fn(o); (acc[k]||(acc[k]=[])).push(o); return acc; }, {}); }
  function fmtMoney(n){ if(n==null || !Number.isFinite(n)) return ''; return '€ ' + fmtMoneyNum(n); }
  function fmtMoneyNum(n){ return n.toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2}); }
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function pillClass(type){ if(type.includes('Annulla')||type.includes('Annullo')) return 'bad'; if(type.includes('Scontrino')||type.includes('Movimento')||type.includes('Preconto')) return 'ok'; return ''; }

  function renderDailyAnalysis() {
    if (!allEvents.length) return;
    const uniqueDays = [...new Set(allEvents.map(e => e.ts.split(' ')[0]))].sort();
    if (daysList) {
      daysList.innerHTML = '';
      uniqueDays.forEach(day => {
        const dayEvents = getEventsForDay(day);
        const dayStats = calculateDayStats(dayEvents);
        const dayItem = document.createElement('div');
        dayItem.className = 'day-item';
        if (day === selectedDay) dayItem.classList.add('selected');
        dayItem.innerHTML = `<div><div style="font-weight: 600;">${formatDisplayDate(day)}</div><div class="day-stats">${dayEvents.length} eventi</div></div><div class="day-stats">€${fmtMoneyNum(dayStats.total)}</div>`;
        dayItem.addEventListener('click', () => selectDay(day));
        daysList.appendChild(dayItem);
      });
      if (!selectedDay && uniqueDays.length > 0) { selectDay(uniqueDays[uniqueDays.length - 1]); }
      if (selectedDay && dailyDatePicker) { dailyDatePicker.value = selectedDay; }
    }
  }

  function selectDay(day) {
    selectedDay = day;
    if (dailyDatePicker) { dailyDatePicker.value = day; }
    document.querySelectorAll('.day-item').forEach(item => { item.classList.remove('selected'); });
    document.querySelectorAll('.day-item').forEach((item, index) => {
      const uniqueDays = [...new Set(allEvents.map(e => e.ts.split(' ')[0]))].sort();
      if (uniqueDays[index] === day) { item.classList.add('selected'); }
    });
    renderDayDetails(day);
  }

  function renderDayDetails(day) {
    const dayEvents = getEventsForDay(day);
    const dayStats = calculateDayStats(dayEvents);
    if (selectedDateDisplay) selectedDateDisplay.textContent = formatDisplayDate(day);
    if (dailyEventsCount) dailyEventsCount.textContent = dayEvents.length;
    if (dailyScontrini) dailyScontrini.textContent = fmtMoney(dayStats.scontrini);
    if (dailyGestionali) dailyGestionali.textContent = fmtMoney(dayStats.gestionali);
    if (dailyPreconti) dailyPreconti.textContent = fmtMoney(dayStats.preconti);
    renderHourlyDistribution(dayEvents);
    renderDailyOperators(dayEvents);
    renderDailyTimeline(dayEvents);
  }

  function renderHourlyDistribution(events) {
    if (!hourlyDistribution) return;
    const hourlyStats = {};
    for (let i = 0; i < 24; i++) { hourlyStats[i] = { count: 0, amount: 0 }; }
    events.forEach(event => {
      const hour = parseInt(event.ts.split(' ')[1].split(':')[0]);
      hourlyStats[hour].count++;
      hourlyStats[hour].amount += event.amount || 0;
    });
    const maxCount = Math.max(...Object.values(hourlyStats).map(h => h.count));
    hourlyDistribution.innerHTML = '';
    Object.entries(hourlyStats).forEach(([hour, stats]) => {
      if (stats.count === 0) return;
      const barWidth = maxCount > 0 ? (stats.count / maxCount) * 100 : 0;
      const item = document.createElement('div');
      item.style.marginBottom = '4px';
      item.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;"><span>${hour.padStart(2, '0')}:00</span><span>${stats.count} eventi</span><span>€${fmtMoneyNum(stats.amount)}</span></div><div class="hourly-bar" style="width: ${barWidth}%"></div>`;
      hourlyDistribution.appendChild(item);
    });
  }

  function renderDailyOperators(events) {
    if (!dailyOperators) return;
    const operatorStats = {};
    events.forEach(event => {
      const op = event.operator || 'Sconosciuto';
      if (!operatorStats[op]) { operatorStats[op] = { count: 0, amount: 0, types: {} }; }
      operatorStats[op].count++;
      operatorStats[op].amount += event.amount || 0;
      const type = event.type;
      operatorStats[op].types[type] = (operatorStats[op].types[type] || 0) + 1;
    });
    dailyOperators.innerHTML = '';
    Object.entries(operatorStats).sort(([,a], [,b]) => b.count - a.count).forEach(([op, stats]) => {
      const typesList = Object.entries(stats.types).map(([type, count]) => `${type}: ${count}`).join(' • ');
      const opDiv = document.createElement('div');
      opDiv.style.marginBottom = '8px';
      opDiv.style.padding = '8px';
      opDiv.style.background = '#0b1220';
      opDiv.style.border = '1px solid var(--border)';
      opDiv.style.borderRadius = '6px';
      opDiv.style.fontSize = '12px';
      opDiv.innerHTML = `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><strong>${escapeHtml(op)}</strong><span>${stats.count} eventi • €${fmtMoneyNum(stats.amount)}</span></div><div style="color: var(--muted); font-size: 11px;">${typesList}</div>`;
      dailyOperators.appendChild(opDiv);
    });
  }

  function renderDailyTimeline(events) {
    if (!dailyTimeline) return;
    const sortedEvents = [...events].sort((a, b) => a.ts.localeCompare(b.ts));
    dailyTimeline.innerHTML = '';
    sortedEvents.forEach(event => {
      const time = event.ts.split(' ')[1].substring(0, 5);
      const item = document.createElement('div');
      item.className = 'timeline-item';
      item.innerHTML = `<div class="timeline-time">${time}</div><div class="timeline-content"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="pill ${pillClass(event.type)}">${escapeHtml(event.type)}</span><span style="font-weight: 600;">${fmtMoney(event.amount)}</span></div><div class="timeline-operator">${escapeHtml(event.operator || 'Sconosciuto')} • ${escapeHtml(event.note || '')}</div></div>`;
      dailyTimeline.appendChild(item);
    });
    if (sortedEvents.length === 0) { dailyTimeline.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">Nessun evento per questo giorno</div>'; }
  }

  function getEventsForDay(day) { return getFiltered().filter(event => event.ts.startsWith(day)); }

  function calculateDayStats(events) {
    return {
      scontrini: sumBy(events.filter(e => e.type === 'Scontrino fiscale'), 'amount'),
      gestionali: sumBy(events.filter(e => e.type === 'Movimento gestionale (non fiscale)'), 'amount'),
      preconti: sumBy(events.filter(e => e.type === 'Preconto sospeso'), 'amount'),
      total: sumBy(events, 'amount')
    };
  }

  window.switchTab = function(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('[id$="Tab"]').forEach(t => t.classList.add('hide'));
    const tabIndex = tab === 'overview' ? 1 : tab === 'daily' ? 2 : 3;
    document.querySelector(`.tab:nth-child(${tabIndex})`).classList.add('active');
    document.getElementById(tab + 'Tab').classList.remove('hide');
    currentTab = tab;
    if (tab === 'daily') { renderDailyAnalysis(); } else if (tab === 'details') { render(); }
  };

  window.setQuickRange = function(type) {
    const today = new Date();
    if (type === 'today') {
      period1Start.value = formatDate(today);
      period1End.value = formatDate(today);
    } else if (type === 'week') {
      const thisWeekStart = new Date(today);
      thisWeekStart.setDate(today.getDate() - today.getDay());
      const thisWeekEnd = new Date(thisWeekStart);
      thisWeekEnd.setDate(thisWeekStart.getDate() + 6);
      period1Start.value = formatDate(thisWeekStart);
      period1End.value = formatDate(thisWeekEnd);
    } else if (type === 'month') {
      const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      period1Start.value = formatDate(thisMonthStart);
      period1End.value = formatDate(thisMonthEnd);
    }
    render();
  };

  drop.addEventListener('dragover', e=>{e.preventDefault(); drop.style.borderColor = '#93c5fd';});
  drop.addEventListener('dragleave', ()=>{drop.style.borderColor = '#475569';});
  drop.addEventListener('drop', e=>{
    e.preventDefault();drop.style.borderColor = '#475569';
    if(e.dataTransfer.files && e.dataTransfer.files[0]){ handleFile(e.dataTransfer.files[0]); }
  });
  fileInput.addEventListener('change', ()=>{ if(fileInput.files[0]) handleFile(fileInput.files[0]); });

  function handleFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result; 
      const {events, metaInfo} = parseLog(text);
      allEvents = events;
      allTypes = new Set(events.map(e=>e.type));
      allOperators = new Set(events.map(e=> e.operator || 'Sconosciuto'));
      renderMeta(metaInfo, file.name);
      renderFilters();
      setDefaultDateRange();
      renderDailyAnalysis();
      render();
    };
    reader.readAsText(file);
  }

  function setDefaultDateRange() {
    if (!allEvents.length) return;
    const dates = allEvents.map(e => e.ts.split(' ')[0]).sort();
    const minDate = dates[0];
    const maxDate = dates[dates.length - 1];
    period1Start.value = minDate;
    period1End.value = maxDate;
  }

  if (dailyDatePicker) {
    dailyDatePicker.addEventListener('change', () => {
      if (dailyDatePicker.value) { selectDay(dailyDatePicker.value); }
    });
  }

  function renderMeta(metaInfo, fileName){
    meta.innerHTML = '';
    const tags = [`File: <b>${escapeHtml(fileName)}</b>`, `Righe: <b>${metaInfo.lines}</b>`, `Eventi rilevati: <b>${metaInfo.events}</b>`];
    for(const t of tags){
      const span = document.createElement('div');
      span.className = 'tag';
      span.innerHTML = t;
      meta.appendChild(span);
    }
  }

  function renderFilters(){
    typeChips.innerHTML = '';
    Array.from(allTypes).sort().forEach(t=>{
      const lbl = document.createElement('label');
      lbl.className = 'chip';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = true;
      cb.dataset.type = t;
      cb.addEventListener('change', render);
      const text = document.createElement('span');
      text.textContent = t;
      lbl.appendChild(cb); lbl.appendChild(text);
      typeChips.appendChild(lbl);
    });

    operatorSelect.innerHTML = '';
    Array.from(allOperators).sort().forEach(op=>{
      const opt = document.createElement('option');
      opt.value = op; opt.textContent = op;
      opt.selected = true;
      operatorSelect.appendChild(opt);
    });

    operatorSelect.addEventListener('change', render);
    searchInput.addEventListener('input', debounce(render, 200));
    
    const applyBtn = document.getElementById('btnApplyPeriod');
    if (applyBtn) {
      applyBtn.onclick = () => { render(); };
    }
    
    btnReset.onclick = ()=>{
      [...typeChips.querySelectorAll('input[type="checkbox"]')].forEach(cb=> cb.checked = true);
      [...operatorSelect.options].forEach(o=> o.selected = true);
      searchInput.value = '';
      render();
    };

    btnExport.onclick = ()=>{
      const filtered = getFiltered();
      const csv = toCSV(filtered);
      const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      const a = document.createElement('a');
      a.href = url; a.download = 'pos-log-estrazione.csv';
      a.click();
      URL.revokeObjectURL(url);
    };
  }

  function getActiveTypes(){
    const act = new Set();
    typeChips.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) act.add(cb.dataset.type);});
    return act;
  }

  function getSelectedOperators(){
    return new Set([...operatorSelect.options].filter(o=>o.selected).map(o=>o.value));
  }

  function getFiltered(){
    const activeTypes = getActiveTypes();
    const selectedOps = getSelectedOperators();
    const term = searchInput.value.trim().toLowerCase();
    return allEvents.filter(e=>{
      if(!activeTypes.has(e.type)) return false;
      if(!selectedOps.has(e.operator || 'Sconosciuto')) return false;
      if(term){
        const hay = `${e.type} ${e.operator||''} ${e.note||''}`.toLowerCase();
        if(!hay.includes(term)) return false;
      }
      return true;
    });
  }

  function render(){
    const rows = getFiltered();
    
    if (currentTab === 'details') {
      tbody.innerHTML='';
      for(const e of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(e.ts)}</td><td>${escapeHtml(e.operator || 'Sconosciuto')}</td><td><span class="pill ${pillClass(e.type)}">${escapeHtml(e.type)}</span></td><td>${fmtMoney(e.amount)}</td><td>${escapeHtml(e.note || '')}</td>`;
        tbody.appendChild(tr);
      }
    }

    kpiEvents.textContent = String(rows.length);
    kpiScontrini.textContent = fmtMoney(sumBy(rows.filter(e=>e.type==='Scontrino fiscale'), 'amount'));
    kpiGestionali.textContent = fmtMoney(sumBy(rows.filter(e=>e.type==='Movimento gestionale (non fiscale)'), 'amount'));
    kpiPreconti.textContent = fmtMoney(sumBy(rows.filter(e=>e.type==='Preconto sospeso'), 'amount'));

    if (currentTab === 'overview') {
      statsOperators.innerHTML = '';
      const perOp = groupBy(rows, e=>e.operator || 'Sconosciuto');
      Object.entries(perOp).forEach(([op, list])=>{
        const countByType = groupBy(list, e=>e.type);
        const parts = Object.entries(countByType).map(([t, arr])=>`${t}: <b>${arr.length}</b>`);
        const tot = sumBy(list, 'amount');
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `<b>${escapeHtml(op)}</b> — eventi: <b>${list.length}</b>, importo: <b>€ ${fmtMoneyNum(tot)}</b><br><span style="font-size:11px;color:#9ca3af">${parts.join(' · ')}</span>`;
        statsOperators.appendChild(tag);
      });
    }

    if (currentTab === 'daily') { renderDailyAnalysis(); }
  }

  function parseLog(text){
    const lines = text.split(/\r?\n/);
    const events = [];
    let currentOperator = null;
    let header = resetHeader();
    let lastPaymentTotal = null;

    for(const raw of lines){
      const line = raw.trim();
      if(!line) continue;
      const m = line.match(/^(?<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(?:\.\d{3})?);(?:(?<who>[^;]*);)?\s*(?<msg>.*)$/);
      if(!m) continue;
      const ts = m.groups.ts;
      const who = (m.groups.who||'').trim();
      const msg = (m.groups.msg||'').trim();

      if(who){ currentOperator = who.replace(/\s*-\s*\d+$/,'').trim() || currentOperator; }
      const logIn = msg.match(/CASSIERE\s+(.+?)\s+LOGGATO/i);
      if(logIn){ currentOperator = logIn[1].trim(); }

      const tav = msg.match(/7\/1\/1\/Tavolo:\s*([^/]+)/);
      if(tav){ header.tavolo = tav[1].trim(); }
      const sala = msg.match(/7\/1\/1\/Sala:\s*([^/]+)/);
      if(sala){ header.sala = sala[1].trim(); }
      const conto = msg.match(/7\/1\/1\/CONTO\s+(\d+)/i) || msg.match(/7\/1\/1\/Conto\s+(\d+)/i);
      if(conto){ header.conto = conto[1]; }
      const total = msg.match(/7\/1\/2\/TOTAL\s+([\d\.,]+)/);
      if(total){ header.total = parseAmount(total[1]); }
      const docId = msg.match(/7\/1\/1\/(\d{8})/);
      if(docId){ header.docId = docId[1]; }

      const elim = msg.match(/ELIMINA RIGA\s+(.+)/i);
      if(elim){ events.push(ev(ts, currentOperator, 'Elimina riga', null, `Riga: ${elim[1].trim()}`)); }

      const annCnt = msg.match(/AVVIATA PROCEDURA RIMOZIONE PRODOTTI AL CONTO\s+(\d+)/i);
      if(annCnt){ events.push(ev(ts, currentOperator, 'Annulla conto', null, `Conto ${annCnt[1]}`)); continue; }

      if(/ANNULLA TUTTI I CONTI APERTI/i.test(msg)){ events.push(ev(ts, currentOperator, 'Annulla tutti i conti', null, 'Tutti i conti aperti')); continue; }

      const pay = msg.match(/AVVIO PAGAMENTO CONTANTI\s*-\s*Totale\s*([\d\.,]+)/i);
      if(pay){ lastPaymentTotal = parseAmount(pay[1]); }

      const printSc = msg.match(/AVVIATA STAMPA SCONTRINO.*?EURO\s*([\d\.,]+)/i);
      if(printSc){ const amount = parseAmount(printSc[1]) ?? lastPaymentTotal ?? null; events.push(ev(ts, currentOperator, 'Scontrino fiscale', amount, headerNote(header))); header = resetHeader(); lastPaymentTotal = null; continue; }

      if(/SF20\s*-\s*SENT COMMAND\s*\+\//.test(msg)){ const amount = lastPaymentTotal; events.push(ev(ts, currentOperator, 'Documento di annullo', amount, 'Annullo documento fiscale')); continue; }

      if(/x\/1\/{3}01/.test(msg)){ events.push(ev(ts, currentOperator, 'Lettura parziale (X)', null, 'Riepilogo giornata senza chiusura')); continue; }
      if(/CLICCATO TASTO CHIUSURA FISCALE/i.test(msg) || /x\/7\/{3}07/.test(msg)){ events.push(ev(ts, currentOperator, 'Chiusura fiscale (Z)', null, 'Chiusura giornaliera')); continue; }

      if(/\sm\/.+/.test(msg)){ const isTav = header.tavolo && !/BANCO/i.test(header.tavolo); const type = isTav ? 'Preconto sospeso' : 'Movimento gestionale (non fiscale)'; events.push(ev(ts, currentOperator, type, header.total ?? null, headerNote(header))); header = resetHeader(); continue; }
    }

    return {events, metaInfo: {lines: lines.length, events: events.length}};
  }

  function headerNote(h){ const parts = []; if(h.tavolo) parts.push(`Tavolo: ${h.tavolo}`); if(h.sala) parts.push(`Sala: ${h.sala}`); if(h.conto) parts.push(`Conto: ${h.conto}`); if(h.docId) parts.push(`Doc: ${h.docId}`); return parts.join(' · '); }
  function resetHeader(){ return { tavolo:null, sala:null, conto:null, total:null, docId:null }; }
  function ev(ts, operator, type, amount, note){ return { ts, operator: operator || 'Sconosciuto', type, amount: amount ?? null, note: note || '' }; }
  function parseAmount(s){ if(s==null) return null; const x = String(s).replace(/\./g,'').replace(/,/g,'.'); const n = parseFloat(x); return Number.isFinite(n) ? n : null; }
  function toCSV(rows){ const cols = ['ts','operator','type','amount','note']; const head = cols.join(';'); const body = rows.map(r=> cols.map(c=> csvCell(r[c])).join(';')).join('\n'); return head+'\n'+body; }
  function csvCell(v){ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return '"'+s+'"'; }

})();
</script>
</body>
</html>
